{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Bienvenue sur le Dashboard Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Style -->
  <style>
    :root{
      --bg-1: #0f2027;
      --bg-2: #203a43;
      --bg-3: #2c5364;
      --card-bg: rgba(255,255,255,0.06);
      --muted: #9fb6c6;
      --accent: #1e90ff;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg,var(--bg-1),var(--bg-2),var(--bg-3));
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px;
    }
  .container{ width:100%; max-width:1200px; padding:0 16px; }

    header {
      text-align: left;
      margin-bottom: 20px;
      animation: fadeIn 1s ease-in-out;
      width:100%;
    }

    header .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; }

    header h1 {
      font-size: 1.9rem;
      margin: 0 0 6px 0;
    }

    header p {
      font-size: 0.95rem;
      color: var(--muted);
      margin:0;
    }

    .salle-select {
      margin: 22px 0 28px 0;
      animation: slideDown 1s ease-in-out;
      display:flex; align-items:center; gap:12px;
    }

    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      background-color: #fff;
      color: #333;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .filtre-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 20px;
      width: 100%;
      min-height:110px;
      box-shadow: 0 10px 40px rgba(2,8,12,0.45);
      animation: fadeInUp 0.8s ease-in-out;
      transition: transform 0.22s ease, box-shadow 0.22s ease;
    }

    .filtre-card:hover {
      transform: scale(1.02);
    }

    .filtre-card h2 {
      margin-bottom: 8px;
      font-size: 1.15rem;
    }

    .slider {
      width: 100%;
      margin-top: 8px;
      -webkit-appearance: none;
      height:6px; background:linear-gradient(90deg,#1e90ff,#6ad1ff); border-radius:6px; outline:none;
    }
    .slider::-webkit-slider-thumb{ -webkit-appearance:none; width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid var(--accent);cursor:pointer; }

    .vitesse-label {
      margin-top: 6px;
      font-size: 0.98rem;
      font-weight: 600;
      color: #dff6ff;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media screen and (max-width: 800px) {
      header h1 { font-size:1.2rem; }
      .filtre-card { padding:14px; }
      .container{ padding:0 12px }
    }

    /* Toast styles */
    #toast-container div{ animation: toast-in 0.25s ease; }
    @keyframes toast-in{ from{opacity:0; transform: translateY(-6px)} to{opacity:1; transform:none} }

  /* Badge / icon styles */
  .badge { display:inline-block;padding:4px 8px;border-radius:999px;font-size:0.78rem;background:rgba(255,255,255,0.06);color:var(--muted); }
  .type-badge { font-weight:600;color:#042c3c;background:linear-gradient(90deg,#ffd27a,#ffb86b);padding:6px 8px;border-radius:8px; }
  .capteur-badge { font-weight:600;color:#073a1a;background:linear-gradient(90deg,#b8ffb0,#7ae37a);padding:4px 8px;border-radius:8px;margin-left:6px }

  /* confirmation icon next to item */
  .confirm-icon{ margin-left:8px; width:18px;height:18px; display:inline-block; vertical-align:middle; opacity:0; transform:scale(0.85); transition:opacity 0.18s ease, transform 0.18s ease; }
  .confirm-icon.show{ opacity:1; transform:scale(1); }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;">
        <a href="/client/client_salle_all/" 
          style="background:var(--accent);color:#fff;padding:8px 12px;
                  border-radius:8px;text-decoration:none;
                  box-shadow:0 6px 18px rgba(30,144,255,0.18);">
          üè† G√©rer les salles
        </a>
      </div>
      <div class="topbar">
        <div>
          <h1>üëã Dashboard Client</h1>
          <p>Contr√¥lez vos filtres d‚Äôair en toute simplicit√©</p>
        </div>
        <div style="text-align:right; color:var(--muted); font-size:0.9rem">Client view</div>
      </div>
      {% if mode == 'salle' %}
        <div style="margin-top:12px;display:flex;justify-content:flex-end;">
          <a href="/client/" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;box-shadow:0 6px 18px rgba(30,144,255,0.18);">‚Üê Accueil</a>
        </div>
      {% endif %}
    </header>

  <!-- Messages Django -->
  {% if messages %}
    <div style="width:100%;max-width:700px;margin-bottom:16px;">
      {% for message in messages %}
        <div style="padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(0,0,0,0.25);">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="GET" class="salle-select">
    <label for="salle">üè† Choisir une salle :</label>
    {% if mode == 'salle' %}
      <select name="salle" id="salle" onchange="this.form.submit()">
        {% if salles_exists %}
          {% for salle in salles %}
            <option value="{{ salle.id }}" {% if salle_id and salle.id|stringformat:"s" == salle_id %}selected{% endif %}>{{ salle.nom }}</option>
          {% endfor %}
        {% else %}
          <option value="">Aucune salle disponible ‚Äî contactez l'admin</option>
        {% endif %}
      </select>
    {% else %}
      <!-- in full mode the select is replaced by links to each salle page -->
      {% if salles_exists %}
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          {% for salle in salles %} 
            <a href="/client/salles/{{ salle.id }}/" class="badge" style="text-decoration:none;color:inherit;">{{ salle.nom }}</a>
          {% endfor %}
        </div>
      {% else %}
        <div style="color:var(--muted)">Aucune salle disponible</div>
      {% endif %}
    {% endif %}
  </form>

  {% if mode == 'salle' %}
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:26px;">
  {% for filtre in filtres %}
  <div class="filtre-card" style="padding:20px;">
      <h2>{{ filtre.nom }}</h2>
      <input class="slider" type="range" min="0" max="100" value="{{ filtre.vitesse }}" onchange="updateVitesse({{ filtre.id }}, this.value)">
      <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
        <div class="vitesse-label">Vitesse : <span id="vitesse-{{ filtre.id }}">{{ filtre.vitesse }}%</span></div>
        <span id="confirm-{{ filtre.id }}" class="confirm-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" stroke="#9ff" stroke-width="2" fill="rgba(28,200,180,0.06)"/><path d="M7 12.5l2.5 2.5L17 8" stroke="#bfffdc" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
      </div>
      <div style="margin-top:12px;display:flex;align-items:center;gap:8px;">
        <label for="salle-for-{{ filtre.id }}" style="font-size:0.95rem;color:#cfe7ee;">Salle :</label>
        <select id="salle-for-{{ filtre.id }}" data-filtre-id="{{ filtre.id }}" class="change-salle-select" style="padding:6px;border-radius:6px;border:none;background:#fff;color:#333;">
          <option value="">Aucune</option>
          {% for s in salles %}
            <option value="{{ s.id }}" {% if filtre.salle and s.id == filtre.salle.id %}selected{% endif %}>{{ s.nom }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  {% empty %}
    <p>Aucun filtre dans cette salle.</p>
  {% endfor %}
  </div>
  {% endif %}

  <script>
    function updateVitesse(filtreId, vitesse) {
      const label = document.getElementById("vitesse-" + filtreId);
      const slider = document.querySelector(`input[type=range][onchange*="updateVitesse(${filtreId}"]`) || document.getElementById(`vitesse-${filtreId}`);
      label.innerText = vitesse + "%";
      try { if (slider) slider.disabled = true; } catch(e){}
      fetch(`/api/filtre/${filtreId}/vitesse/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({vitesse: vitesse})
      }).then(resp => {
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.json();
      }).then(data => {
        if (data && data.message) {
          showToast(data.message);
          try { const cid = document.getElementById('confirm-' + filtreId); if (cid) { cid.classList.add('show'); setTimeout(()=>cid.classList.remove('show'),2000); }} catch(e){}
        }
      }).catch(err => {
        showToast('Erreur lors de la mise √† jour de la vitesse');
      }).finally(() => { try { if (slider) slider.disabled = false; } catch(e){} });
    }
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(msg) {
      const container = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.background = 'rgba(0,0,0,0.8)';
      el.style.color = '#fff';
      el.style.padding = '8px 12px';
      el.style.borderRadius = '6px';
      el.style.marginTop = '6px';
      container.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.change-salle-select').forEach(function(sel){
        sel.addEventListener('change', function(e){
          const filtreId = sel.dataset.filtreId;
          const salleId = sel.value;
          const url = `/client/filtre/${filtreId}/change_salle/`;
          sel.disabled = true;
          fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({salle: salleId})
          }).then(r => r.json()).then(data => {
            if (data && data.message) {
              showToast(data.message);
              try { const cid = document.getElementById('confirm-' + filtreId); if (cid) { cid.classList.add('show'); setTimeout(()=>cid.classList.remove('show'),2000); }} catch(e){}
            }
          }).catch(err => {
            showToast('Erreur r√©seau');
          }).finally(() => { sel.disabled = false; });
        });
      });
    });
  </script>

  <div id="toast-container" style="position:fixed;right:20px;top:20px;z-index:9999"></div>

  <section style="width:100%;max-width:1100px;margin-top:48px;padding:6px 0;">
    <h2 style="color:#fff;margin-bottom:12px;">Vue compl√®te (lecture seule)</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px;">
      {% for f in all_filtres %}
        <div style="background:rgba(255,255,255,0.04);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.25);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong style="color:#fff">{{ f.nom }}</strong>
            <span style="color:#9fb6c6;font-size:0.9rem">Vitesse: {{ f.vitesse }}%</span>
          </div>
          <div style="margin-top:8px;color:#d6e6ea">Localisation: {{ f.localisation }}</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
            <label style="color:#cfe7ee;font-size:0.9rem;min-width:40px;">Salle:</label>
            <select class="change-salle-select" data-filtre-id="{{ f.id }}" style="flex:1;padding:6px;border-radius:6px;border:none;background:#fff;color:#333;">
              <option value="">Aucune</option>
              {% for s in salles %}
                <option value="{{ s.id }}" {% if f.salle and s.id == f.salle.id %}selected{% endif %}>{{ s.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="margin-top:10px;color:#cfe7ee;font-size:0.9rem">
            Capteurs associ√©s:
            <ul style="margin:6px 0 0 16px;padding:0;">
              {% for c in capteurs %}
                {% if c.filtre_id == f.id %}
                  <li style="color:#eaf6f9;margin-bottom:4px;">{{ c.nom }} ({{ c.type }}) ‚Äî {{ c.valeur }}</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>
      {% empty %}
        <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;color:#ddd;">Aucun filtre</div>
      {% endfor %}
    </div>
  </section>
  <!-- Ajoutez cette section juste avant la fermeture de la div container -->
<div style="width:100%; max-width:1100px; margin:40px 0;">
  <h2 style="color:#fff; margin-bottom:20px; text-align:center;">Graphiques des donn√©es des capteurs</h2>
  
  <!-- Section de debug visible -->
  <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h4 style="color: #fff; margin: 0 0 10px 0;">Informations de debug:</h4>
    <p style="color: #fff; margin: 5px 0;">Nombre de filtres: <strong>{{ all_filtres.count }}</strong></p>
    <p style="color: #fff; margin: 5px 0;">Nombre de capteurs: <strong>{{ capteurs.count }}</strong></p>
    <div style="color: #fff; margin-top: 10px;">
      <h5 style="margin: 5px 0;">D√©tails des filtres:</h5>
      {% for filtre in all_filtres %}
        <div style="margin-left: 20px;">
          - {{ filtre.nom }} (ID: {{ filtre.id }}, Actif: {{ filtre.actif }}, Vitesse: {{ filtre.vitesse }})
        </div>
      {% empty %}
        <div style="margin-left: 20px;">Aucun filtre trouv√©</div>
      {% endfor %}
    </div>
  </div>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Graphique √âvolution des valeurs -->
    <div style="background: var(--card-bg); padding: 20px; border-radius: 12px;">
      <h3 style="color: #fff; margin-bottom: 15px; text-align: center;">√âvolution des valeurs des capteurs</h3>
      <canvas id="evolutionChart"></canvas>
    </div>

    <!-- Graphique √âtat des filtres -->
    <div style="background: var(--card-bg); padding: 20px; border-radius: 12px;">
      <h3 style="color: #fff; margin-bottom: 15px; text-align: center;">√âtat des filtres</h3>
      <canvas id="stateChart"></canvas>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
    <!-- Graphique Vitesse des filtres -->
    <div style="background: var(--card-bg); padding: 20px; border-radius: 12px;">
      <h3 style="color: #fff; margin-bottom: 15px; text-align: center;">Vitesse des filtres</h3>
      <canvas id="speedChart"></canvas>
    </div>

    <!-- Graphique Distribution des valeurs -->
    <div style="background: var(--card-bg); padding: 20px; border-radius: 12px;">
      <h3 style="color: #fff; margin-bottom: 15px; text-align: center;">Distribution des valeurs</h3>
      <canvas id="distributionChart"></canvas>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log("=== INITIALISATION GRAPHIQUES ===");
  
  // V√©rification des donn√©es
  console.log("Filtres disponibles:", {{ all_filtres.count }});
  console.log("Capteurs disponibles:", {{ capteurs.count }});
  
  {% for filtre in all_filtres %}
    console.log("Filtre: {{ filtre.nom }} (ID:{{ filtre.id }}), Actif:{{ filtre.actif }}, Vitesse:{{ filtre.vitesse }}");
  {% endfor %}
  
  {% for capteur in capteurs %}
    console.log("Capteur: {{ capteur.nom }}, Valeur:{{ capteur.valeur }}, Filtre:{{ capteur.filtre.id }}");
  {% endfor %}

  // Graphique 1: √âvolution des valeurs
  const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
  const allValues = [
    {% for capteur in capteurs %}
      {% if capteur.valeur %}
        {{ capteur.valeur }},
      {% else %}
        0,
      {% endif %}
    {% endfor %}
  ];
  
  if (allValues.length > 0) {
    new Chart(evolutionCtx, {
      type: 'line',
      data: {
        labels: Array.from({length: allValues.length}, (_, i) => `M${i+1}`),
        datasets: [{
          label: 'Valeurs des capteurs',
          data: allValues,
          borderColor: '#36A2EB',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
          y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        }
      }
    });
  } else {
    evolutionCtx.fillStyle = '#fff';
    evolutionCtx.font = '14px Arial';
    evolutionCtx.fillText('Aucune donn√©e de capteur disponible', 10, 50);
  }

  // Graphique 2: √âtat des filtres
  const stateCtx = document.getElementById('stateChart').getContext('2d');
  
  // Calculer les √©tats - CORRECTION: utiliser all_filtres au lieu de filtres
  let activeCount = 0;
  let inactiveCount = 0;
  
  {% for filtre in all_filtres %}
    {% if filtre.actif %}
      activeCount++;
    {% else %}
      inactiveCount++;
    {% endif %}
  {% endfor %}
  
  console.log("√âtat - Actifs:", activeCount, "Inactifs:", inactiveCount);
  
  if (activeCount > 0 || inactiveCount > 0) {
    new Chart(stateCtx, {
      type: 'doughnut',
      data: {
        labels: ['Filtres Actifs', 'Filtres Inactifs'],
        datasets: [{
          data: [activeCount, inactiveCount],
          backgroundColor: ['#4BC0C0', '#FF6384'],
          borderColor: 'rgba(255,255,255,0.3)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { 
              color: '#fff',
              font: { size: 14 }
            }
          }
        }
      }
    });
  } else {
    stateCtx.fillStyle = '#fff';
    stateCtx.font = '14px Arial';
    stateCtx.fillText('Aucun filtre trouv√©', 10, 50);
  }

  // Graphique 3: Vitesse des filtres
  const speedCtx = document.getElementById('speedChart').getContext('2d');
  
  const filterNames = [];
  const filterSpeeds = [];
  
  {% for filtre in all_filtres %}  {# CORRECTION: utiliser all_filtres #}
    filterNames.push('{{ filtre.nom }}');
    filterSpeeds.push({{ filtre.vitesse }});
  {% endfor %}
  
  console.log("Vitesse - Noms:", filterNames, "Vitesses:", filterSpeeds);
  
  if (filterNames.length > 0) {
    new Chart(speedCtx, {
      type: 'bar',
      data: {
        labels: filterNames,
        datasets: [{
          label: 'Vitesse (m/s)',
          data: filterSpeeds,
          backgroundColor: 'rgba(255, 159, 64, 0.7)',
          borderColor: '#FF9F40',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            labels: { color: '#fff' }
          }
        },
        scales: {
          x: { 
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            beginAtZero: true,
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });
  } else {
    speedCtx.fillStyle = '#fff';
    speedCtx.font = '14px Arial';
    speedCtx.fillText('Aucun filtre trouv√©', 10, 50);
  }

  // Graphique 4: Distribution des valeurs
  const distributionCtx = document.getElementById('distributionChart').getContext('2d');
  
  if (allValues.length > 0) {
    const ranges = ['0-20', '21-40', '41-60', '61-80', '81-100', '100+'];
    const distribution = [0, 0, 0, 0, 0, 0];
    
    allValues.forEach(value => {
      if (value <= 20) distribution[0]++;
      else if (value <= 40) distribution[1]++;
      else if (value <= 60) distribution[2]++;
      else if (value <= 80) distribution[3]++;
      else if (value <= 100) distribution[4]++;
      else distribution[5]++;
    });

    new Chart(distributionCtx, {
      type: 'bar',
      data: {
        labels: ranges,
        datasets: [{
          label: 'Nombre de capteurs',
          data: distribution,
          backgroundColor: 'rgba(153, 102, 255, 0.7)',
          borderColor: '#9966FF',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            labels: { color: '#fff' }
          }
        },
        scales: {
          x: { 
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: { 
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });
  } else {
    distributionCtx.fillStyle = '#fff';
    distributionCtx.font = '14px Arial';
    distributionCtx.fillText('Aucune valeur de capteur', 10, 50);
  }
});
</script>
  

  
</body>
</html>
